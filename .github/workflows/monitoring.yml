name: Health Check & Monitoring

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

env:
  DOCKER_USERNAME: tdkps
  IMAGE_NAME: ops-ronin

jobs:
  health-check:
    runs-on: ubuntu-latest
    name: Monitor Docker Hub Image
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check Docker Hub image
      id: image-check
      run: |
        echo "Checking Docker Hub image health..."
        
        # Check if image exists and is pullable
        if docker pull ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest; then
          echo "âœ… Image pull successful"
          echo "status=healthy" >> $GITHUB_OUTPUT
        else
          echo "âŒ Image pull failed"
          echo "status=unhealthy" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # Check image size
        SIZE=$(docker images ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest --format "table {{.Size}}" | tail -n 1)
        echo "Image size: $SIZE"
        echo "size=$SIZE" >> $GITHUB_OUTPUT
        
        # Test basic functionality
        echo "Testing basic functionality..."
        if timeout 10s docker run --rm ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest ./ops-ronin --help 2>&1 | grep -q "menu.yaml not found"; then
          echo "âœ… Basic functionality test passed"
          echo "functionality=working" >> $GITHUB_OUTPUT
        else
          echo "âŒ Basic functionality test failed"
          echo "functionality=failed" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    - name: Check Docker Hub metrics
      run: |
        echo "Checking Docker Hub repository metrics..."
        
        # Get repository info using Docker Hub API
        curl -s "https://hub.docker.com/v2/repositories/${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}/" | \
        jq -r '"Pull count: " + (.pull_count | tostring) + ", Stars: " + (.star_count | tostring) + ", Last updated: " + .last_updated'
    
    - name: Security scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
        format: 'table'
        exit-code: '0'  # Don't fail on vulnerabilities, just report
    
    - name: Create issue on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const title = 'ðŸš¨ Health Check Failed - ' + new Date().toISOString().split('T')[0];
          const body = `
          ## Health Check Failure Report
          
          **Date:** ${new Date().toISOString()}
          **Workflow:** Health Check & Monitoring
          **Status:** Failed
          
          ### Issue Details
          - Docker image pull or functionality test failed
          - Check the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details
          
          ### Actions Needed
          - [ ] Investigate Docker Hub image status
          - [ ] Verify image functionality
          - [ ] Check for any recent breaking changes
          - [ ] Update image if necessary
          
          **Auto-generated by GitHub Actions**
          `;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['bug', 'urgent', 'auto-generated']
          });

  update-readme-stats:
    runs-on: ubuntu-latest
    name: Update Repository Stats
    needs: health-check
    if: success()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Get Docker Hub stats
      id: stats
      run: |
        # Get Docker Hub repository statistics
        STATS=$(curl -s "https://hub.docker.com/v2/repositories/${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}/")
        
        PULL_COUNT=$(echo "$STATS" | jq -r '.pull_count // 0')
        STAR_COUNT=$(echo "$STATS" | jq -r '.star_count // 0')
        LAST_UPDATED=$(echo "$STATS" | jq -r '.last_updated // "unknown"')
        
        echo "pulls=$PULL_COUNT" >> $GITHUB_OUTPUT
        echo "stars=$STAR_COUNT" >> $GITHUB_OUTPUT
        echo "updated=$LAST_UPDATED" >> $GITHUB_OUTPUT
        
        echo "Docker Hub Stats:"
        echo "- Pulls: $PULL_COUNT"
        echo "- Stars: $STAR_COUNT"
        echo "- Last Updated: $LAST_UPDATED"
    
    - name: Update badges in README
      run: |
        # Update dynamic badges in README.md
        sed -i "s/docker%2Fpulls%2F[^?]*/docker%2Fpulls%2F${{ env.DOCKER_USERNAME }}%2F${{ env.IMAGE_NAME }}/g" README.md
        
        # Add pull count badge if not exists
        if ! grep -q "docker/pulls" README.md; then
          sed -i '/Docker Hub/a [![Docker Pulls](https://img.shields.io/docker/pulls/${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }})](https://hub.docker.com/r/${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }})' README.md
        fi
    
    - name: Commit stats update
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if git diff --quiet; then
          echo "No changes to commit"
        else
          git add README.md
          git commit -m "ðŸ¤– Update Docker Hub stats [skip ci]" || echo "No changes to commit"
          git push
        fi
